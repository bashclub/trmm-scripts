#!/bin/bash

# PrÃ¼fen, ob der Bootloader systemd-boot ist
if [ -d "/sys/firmware/efi" ] && bootctl is-installed &>/dev/null; then
    echo "System bootet mit systemd-boot."
else
    echo "System bootet NICHT mit systemd-boot. Skript wird abgebrochen."
    exit 1
fi

# ============================
# Proxmox Update-Skript mit ZFS-Snapshots & Logging
# ============================
# âœ… Snapshots nur erstellen, wenn Updates verfÃ¼gbar sind
# âœ… LÃ¶scht nur Snapshots mit exakt dem Tag `pve-update-via-rmm`
# âœ… Erkennt Kernel-Updates & meldet, ob ein Neustart empfohlen wird
# âœ… VollstÃ¤ndiges Logging fÃ¼r Debugging
# âœ… Exit-Codes:
#    - 0 = Erfolg (keine Updates oder keine Probleme)
#    - 1 = Neustart empfohlen (Kernel-Update)
#    - 2 = Fehler (Paketquellen nicht erreichbar, Keyring-Probleme, Update-Fehler)
# ============================

# ğŸ¯ Einstellungen
ZFS_DATASETS=("rpool/ROOT" "rpool/pveconf")  # Nur OS & Config sichern, keine VMs!
SNAPSHOT_TAG="pve-update-via-rmm"  # Snapshots erhalten diesen Tag
MAX_SNAPSHOTS=5  # Anzahl der Snapshots, die behalten werden
LOGFILE="/var/log/proxmox_update.log"  # Logdatei fÃ¼r Fehler & Update-Verlauf
REBOOT=${REBOOT:-NO}  # Standard: Kein Reboot (nur mit REBOOT=YES)
TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)  # Zeitstempel fÃ¼r Snapshots

# ğŸ”„ **1. Aktualisiere Paketlisten**
if ! apt-get update -qq 2>&1; then
    echo "ğŸŸ¡ Fehler beim Aktualisieren der Paketlisten!"
    echo "Log-Datei fÃ¼r Details: $LOGFILE"
    exit 2
fi

# ğŸ” **2. PrÃ¼fen, ob Updates verfÃ¼gbar sind**
UPGRADE_COUNT=$(apt list --upgradable 2>/dev/null | grep -c "upgradable")

if [[ "$UPGRADE_COUNT" -eq 0 ]]; then
    echo "ğŸŸ¢ Keine neuen Updates verfÃ¼gbar."
    exit 0
fi

# ğŸ“¸ **3. Snapshots vorbereiten**
declare -A SNAPSHOT_NAMES
for dataset in "${ZFS_DATASETS[@]}"; do
    SNAPSHOT_NAMES[$dataset]="${dataset}@${SNAPSHOT_TAG}-$TIMESTAMP"
done

# ğŸ—‘ï¸ **4. Alte Snapshots lÃ¶schen (nur mit exakt passendem Tag!)**
for dataset in "${ZFS_DATASETS[@]}"; do
    SNAPSHOTS_TO_DELETE=$(zfs list -t snapshot -o name | grep "${dataset}@${SNAPSHOT_TAG}-" | head -n -$MAX_SNAPSHOTS)
    if [[ -n "$SNAPSHOTS_TO_DELETE" ]]; then
        echo "$SNAPSHOTS_TO_DELETE" | xargs -n1 zfs destroy -r
    fi
done

# ğŸ“¸ **5. Neue Snapshots erstellen**
for dataset in "${ZFS_DATASETS[@]}"; do
    zfs snapshot "${SNAPSHOT_NAMES[$dataset]}"
done

# â¬†ï¸ **6. Updates installieren**
if ! apt-get dist-upgrade -y 2>&1; then
    echo "ğŸ”´ Fehler beim Installieren der Updates!"
    echo "Details im Log: $LOGFILE"
    exit 2
fi

# ğŸ” **7. PrÃ¼fen, ob ein neuer Kernel installiert wurde**
KERNEL_UPDATE=$(dpkg-query -W -f='${binary:Package}\n' linux-image-* | grep -v "$(uname -r)" | wc -l)

if [[ "$KERNEL_UPDATE" -gt 0 ]]; then
    echo "âš ï¸ Ein neuer Kernel wurde installiert! Ein Neustart wird zeitnah empfohlen."
    for dataset in "${ZFS_DATASETS[@]}"; do
        echo "ğŸ“¸ Snapshot vor Update: ${SNAPSHOT_NAMES[$dataset]}"
    done
    echo "ğŸ—‘ï¸ Alte Snapshots mit Tag $SNAPSHOT_TAG wurden bereinigt."
    exit 1
fi

echo "âœ… Alle Updates wurden erfolgreich installiert. Kein Neustart erforderlich."
for dataset in "${ZFS_DATASETS[@]}"; do
    echo "ğŸ“¸ Snapshot vor Update: ${SNAPSHOT_NAMES[$dataset]}"
done
echo "ğŸ—‘ï¸ Alte Snapshots mit Tag $SNAPSHOT_TAG wurden bereinigt."
exit 0

